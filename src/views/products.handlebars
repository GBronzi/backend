<div class="container mt-4">
    <h1>Productos</h1>

    {{#if products}}
        <div class="row">
            {{#each products}}
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">{{this.title}}</h5>
                            <p class="card-text">{{this.description}}</p>
                            <p class="card-text"><strong>Precio:</strong> ${{this.price}}</p>
                            <p class="card-text"><strong>Stock:</strong> {{this.stock}}</p>
                            <p class="card-text"><strong>Categoría:</strong> {{this.category}}</p>
                            
                            <a href="/products/{{this._id}}" class="btn btn-primary">Ver detalle</a>
                            <button class="btn btn-success" onclick="agregarAlCarrito('{{this._id}}')">Agregar al carrito</button>
                        </div>
                    </div>
                </div>
            {{/each}}
        </div>

        <!-- paginacion -->
        <nav aria-label="Paginación">
            <ul class="pagination justify-content-center">
                {{#if hasPrevPage}}
                    <li class="page-item">
                        <a class="page-link" href="/products?page={{prevPage}}">Anterior</a>
                    </li>
                {{else}}
                    <li class="page-item disabled">
                        <span class="page-link">Anterior</span>
                    </li>
                {{/if}}

                <li class="page-item active">
                    <span class="page-link">Página {{page}} de {{totalPages}}</span>
                </li>

                {{#if hasNextPage}}
                    <li class="page-item">
                        <a class="page-link" href="/products?page={{nextPage}}">Siguiente</a>
                    </li>
                {{else}}
                    <li class="page-item disabled">
                        <span class="page-link">Siguiente</span>
                    </li>
                {{/if}}
            </ul>
        </nav>
    {{else}}
        <p>No hay productos disponibles</p>
    {{/if}}
</div>

<script>
    // crear carrito al cargar la pagina
    async function crearCarrito() {
        let cartId = localStorage.getItem('cartId');

        if (!cartId) {
            try {
                const response = await fetch('/api/carts', {
                    method: 'POST'
                });
                const data = await response.json();
                cartId = data.data._id;
                localStorage.setItem('cartId', cartId);
                console.log('carrito creado:', cartId);
            } catch (error) {
                console.error('error al crear carrito:', error);
            }
        }

        return cartId;
    }

    // agregar producto al carrito
    async function agregarAlCarrito(productId) {
        const cartId = await crearCarrito();

        if (!cartId) {
            Swal.fire('Error', 'No se pudo crear el carrito', 'error');
            return;
        }

        try {
            const response = await fetch(`/api/carts/${cartId}/product/${productId}`, {
                method: 'POST'
            });

            const data = await response.json();

            if (data.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: 'Producto agregado',
                    text: 'El producto se agregó al carrito',
                    timer: 1500,
                    showConfirmButton: false
                });

                actualizarContador(cartId);
            } else {
                Swal.fire('Error', data.message, 'error');
            }
        } catch (error) {
            console.error('error:', error);
            Swal.fire('Error', 'No se pudo agregar el producto', 'error');
        }
    }

    // actualizar contador del carrito
    async function actualizarContador(cartId) {
        try {
            const response = await fetch(`/api/carts/${cartId}`);
            const data = await response.json();

            let total = 0;
            if (data.data && data.data.products) {
                total = data.data.products.length;
            }

            const badge = document.getElementById('cartCount');
            if (badge) {
                badge.textContent = total;
            }
        } catch (error) {
            console.error('error al actualizar contador:', error);
        }
    }

    // inicializar al cargar
    window.addEventListener('load', async () => {
        const cartId = await crearCarrito();
        if (cartId) {
            actualizarContador(cartId);
        }
    });
</script>

